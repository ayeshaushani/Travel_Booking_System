<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <title>Travel Packages</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            width: 80%;
            margin: 0 auto;
        }
        h2 {
            text-align: center;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        .button {
            padding: 5px 15px;
            margin: 5px;
            cursor: pointer;
        }
        .success {
            background-color: #4CAF50;
            color: white;
        }
        .error {
            background-color: #f44336;
            color: white;
        }
        .form-group {
            margin-bottom: 10px;
        }
        input[type="text"], input[type="number"], textarea, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        img {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Add and Manage Travel Packages</h2>

    <!-- Form to add/edit a package -->
    <div id="formContainer">
        <form id="packageForm" enctype="multipart/form-data">
            <div class="form-group">
                <input type="text" id="name" name="name" placeholder="Package Name" required>
            </div>
            <div class="form-group">
                <input type="text" id="destination" name="destination" placeholder="Destination" required>
            </div>
            <div class="form-group">
                <input type="text" id="duration" name="duration" placeholder="Duration (e.g. 3 Days)" required>
            </div>
            <div class="form-group">
                <input type="number" id="price" name="price" placeholder="Price (LKR)" required>
            </div>
            <div class="form-group">
                <textarea id="description" name="description" placeholder="Description" required></textarea>
            </div>
            <div class="form-group">
                <input type="file" id="image" name="image" accept="image/*" required>
                <img id="imagePreview" class="image-preview" style="display:none;">
            </div>
            <div class="form-group">
                <button type="submit" class="button success">Save Package</button>
            </div>
        </form>
    </div>

    <div id="messageBox" class="message" style="display: none;"></div>

    <!-- Display the list of packages -->
    <h3>Existing Packages</h3>
    <table id="packagesTable">
        <thead>
        <tr>
            <th>Name</th>
            <th>Destination</th>
            <th>Duration</th>
            <th>Price</th>
            <th>Description</th>
            <th>Image</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <!-- Package rows will be added here dynamically -->
        </tbody>
    </table>
    <a href="AdminDashBoard.html"><button>Back</button></a>
</div>

<script>
    // Display message in message box
    function showMessage(msg, type) {
        const messageBox = document.getElementById("messageBox");
        messageBox.innerText = msg;
        messageBox.className = `message ${type}`;
        messageBox.style.display = "block";
        setTimeout(() => {
            messageBox.style.display = "none";
        }, 3000);
    }

    // Handle form submission for creating or editing a package
    $(document).ready(function() {
        $("#packageForm").submit(function(event) {
            event.preventDefault();

            let formData = new FormData();
            formData.append("name", $("#name").val());
            formData.append("destination", $("#destination").val());
            formData.append("duration", $("#duration").val());
            formData.append("price", $("#price").val());
            formData.append("description", $("#description").val());

            let imageFile = $("#image")[0].files[0]; // Image file ekata reference ekak
            if (imageFile) {
                formData.append("image", imageFile);
            }
            console.log("Form Data: ", formData);
            let actionUrl = "http://localhost:8080/travel-packages";
            let method = "POST";

            // Check if it's an update request (if packageId exists)
          const packageId = $("#packageForm").data("packageId");
            if (packageId) {
                actionUrl = `http://localhost:8080/travel-packages/${packageId}`;
                method = "PUT";
            }

            $.ajax({
                url: actionUrl,
                type: method,
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('jwtToken') // ✅ Add JWT token
                },
                data: formData,
                processData: false,
                contentType: false,

                success: function(response) {
                    showMessage("Package saved successfully!", "success");
                    $("#packageForm")[0].reset();
                    $("#imagePreview").hide();
                    loadPackages(); // Refresh package list (Use correct function name)
                },
                error: function(xhr, status, error) {
                    console.error("Error saving package:", error);

                    if (xhr.status === 403) {
                        alert("Access Denied! Please log in again.");
                        localStorage.removeItem("jwtToken"); // Clear invalid token
                        window.location.href = "login.html"; // Redirect to login page
                    } else {
                        showMessage("Error saving package! Please try again.", "error");
                    }
                }
            });
        });
    });

    // Load packages and populate the table using AJAX
    function loadPackages() {
        $.ajax({
            url: "http://localhost:8080/travel-packages",
            type: "GET",
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
            },
            dataType: "json",
            success: function(data) {
                const tableBody = $("#packagesTable tbody");
                tableBody.empty(); // Clear existing rows

                $.each(data, function(index, package) {
                    const imageUrl = `http://localhost:8080/images/${package.image}`;
                    const row = `
                     <tr>
                    <td>${package.name}</td>
                    <td>${package.destination}</td>
                    <td>${package.duration}</td>
                    <td>${package.price}</td>
                    <td>${package.description}</td> <!-- ✅ Description field is correct now -->
                    <td><img src="${imageUrl}" alt="Package Image" width="100"></td> <!-- ✅ Image field is correct now -->
                    <td>
                        <button class="button success" onclick="editPackage(${package.tPackageId})">Edit</button>
                        <button class="button error" onclick="deletePackage(${package.tPackageId})">Delete</button>
                    </td>
                </tr>
                `;
                    tableBody.append(row);
                });
            },
            error: function(xhr, status, error) {
                console.error("Error loading packages:", xhr.status, error);

                if (xhr.status === 403) {
                    alert("Access Denied! Please log in again.");
                    localStorage.removeItem("jwtToken"); // Clear invalid token
                    window.location.href = "login.html"; // Redirect to login page
                } else {
                    alert("Failed to load packages. Please try again.");
                }
            }
        });
    }

    // Load packages when the page is ready
    $(document).ready(function() {
        loadPackages();
    });


    // edit package details
    function editPackage(packageId) {
        // Fetch package details and populate the form
        $.ajax({
            url: `http://localhost:8080/travel-packages/${packageId}`,
            type: "GET",
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("jwtToken")}`
            },
            success: function (package) {
                // Populate form with existing data
                $("#name").val(package.name);
                $("#destination").val(package.destination);
                $("#duration").val(package.duration);
                $("#price").val(package.price);
                $("#description").val(package.description);

                // Set package ID in form
                $("#packageForm").data("packageId", packageId);

                // Set image preview
                if (package.image) {
                    $("#imagePreview").attr("src", `http://localhost:8080/images/${package.image}`).show();
                } else {
                    $("#imagePreview").hide();
                }
            },
            error: function (xhr, status, error) {
                console.error("Error fetching package details:", xhr.responseText);
                alert("Failed to load package details. Please try again.");
            }
        });
    }

    // Update package function
    function updatePackage() {
        const packageId = $("#packageForm").data("packageId"); // Get package ID

        if (!packageId) {
            alert("Error: No package selected for update.");
            return;
        }

        const formData = new FormData();
        formData.append("name", $("#name").val());
        formData.append("destination", $("#destination").val());
        formData.append("duration", $("#duration").val());
        formData.append("price", $("#price").val());
        formData.append("description", $("#description").val());

        // Check if a new image is selected
        const imageFile = $("#image")[0].files[0];
        if (imageFile) {
            formData.append("image", imageFile);
        }

        $.ajax({
            url: `http://localhost:8080/travel-packages/${packageId}`,
            type: "PUT", // ✅ Use PUT for update
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("jwtToken")}`
            },
            data: formData,
            processData: false, // Don't process FormData
            contentType: false, // Don't set content type (browser will do it)
            success: function (response) {
                alert("Package updated successfully!");
                $("#packageForm")[0].reset(); // Clear form after update
                $("#imagePreview").hide(); // Hide image preview if needed
                loadPackages(); // Reload packages list
            },
            error: function (xhr, status, error) {
                console.error("Error updating package:", xhr.responseText);
                alert("Failed to update package. Please try again.");
            }
        });
    }



    // Delete a package
    function deletePackage(id) {
        fetch(`http://localhost:8080/travel-packages/${id}`, {
            method: "DELETE",
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("jwtToken")}`
            },
        })
            .then(response => {
                if (response.ok) {
                    showMessage("Package deleted successfully!", "success");
                    loadPackages(); // Refresh the package list after deletion
                } else {
                    showMessage("Error deleting package!", "error");
                }
            })
            .catch(error => {
                console.error("Error deleting package:", error);
            });
    }

    // Load all packages when the page loads
    window.onload = function() {
       loadPackages();
    };
</script>
<script src="script.js"></script>
</body>
</html>